{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<style>
.sidebar a {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 500;
    font-size: 1rem;
}
.sidebar a i {
    margin-left: 10px;
}
canvas {
    max-height: 300px;
}
</style>


<form method="get" class="mb-4">
    <label for="periodo">Período:</label>
    <select name="periodo" id="periodo" onchange="this.form.submit()">
        <option value="dia" {% if periodo == 'dia' %}selected{% endif %}>Hoje</option>
        <option value="semana" {% if periodo == 'semana' %}selected{% endif %}>Semana</option>
        <option value="mes" {% if periodo == 'mes' %}selected{% endif %}>Mês</option>
        <option value="ano" {% if periodo == 'ano' %}selected{% endif %}>Ano</option>
        <option value="personalizado" {% if periodo == 'personalizado' %}selected{% endif %}>Personalizado</option>
    </select>
    {% if periodo == 'personalizado' %}
    <br>
    Data Inicial:
    <input type="date" name="data_inicio" value="{{ data_inicio|default('') }}">
    Data Final:
    <input type="date" name="data_fim" value="{{ data_fim|default('') }}">
    <button type="submit">Filtrar</button>
    {% endif %}
</form>

<div class="container-fluid">
    <div class="row text-white mb-4">
        <div class="col-md-3">
            <div class="card" style="background: linear-gradient(135deg, #cc2b5e, #753a88);">
                <div class="card-body text-center">
                    <h6>Agendamentos</h6>
                    <p class="fs-4">{{ agendamentos|default(0) }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card" style="background: linear-gradient(135deg, #833ab4, #fd1d1d);">
                <div class="card-body text-center">
                    <h6>Faturamento Total</h6>
                    <p class="fs-4">R$ {{ (comparativo_servico_produto[0] + comparativo_servico_produto[1])|float|round(2) }}</p>
                </div>
            </div>
            
        </div>
   
    </div>

    <!-- Gráfico de faturamento mensal -->
    <div class="row mb-4">
        <div class="col-md-9">
            <div class="card">
                <div class="card-body">
                    <h5 class="text-center">Faturamento Mensal</h5>
                    <canvas id="graficoMensal"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos de Funcionários, Serviços e Produtos -->
    <div class="row mb-4">
        <div class="col-md-6 col-lg-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="text-center">Funcionários</h5>
                    <canvas id="graficoFuncionario"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="text-center">Serviços</h5>
                    <canvas id="graficoServico"></canvas>
                </div>
            </div>
        </div>
       </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
Chart.defaults.color = '#333';
Chart.defaults.plugins.legend.position = 'bottom';

// Faturamento Mensal
new Chart(document.getElementById('graficoMensal'), {
    type: 'line',
    data: {
        labels: {{ meses|tojson }},
        datasets: [{
            label: 'Faturamento',
            data: {{ faturamento_mensal|tojson }},
            borderColor: '#ec407a',
            backgroundColor: 'rgba(236, 64, 122, 0.2)',
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        scales: {
            y: {
                beginAtZero: true,
                ticks: { callback: value => 'R$ ' + value.toLocaleString('pt-BR') }
            }
        }
    }
});

// Funcionários
new Chart(document.getElementById('graficoFuncionario'), {
    type: 'bar',
    data: {
        labels: {{ faturamento_funcionario.keys()|list|tojson }},
        datasets: [{
            label: 'Faturamento',
            data: {{ faturamento_funcionario.values()|list|tojson }},
            backgroundColor: function(context) {
                const value = context.raw;
                return value > 1000 ? '#1e88e5' : '#42a5f5';
            },
            borderSkipped: false,
            maxBarThickness: 30 // largura da barra
        }]
    },
    options: {
        responsive: true,
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return 'R$ ' + context.raw.toLocaleString('pt-BR');
                    }
                }
            },
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: false, // barra não precisa começar do zero
                grid: { drawBorder: false, color: '#eee' },
                ticks: {
                    callback: function(value) {
                        return 'R$ ' + value.toLocaleString('pt-BR');
                    },
                    align: 'start' // valores alinhados à esquerda
                }
            },
            x: { grid: { display: false } }
        },
        animation: { duration: 1000, easing: 'easeOutQuart' }
    }
});

// Serviços (horizontal)
new Chart(document.getElementById('graficoServico'), {
    type: 'bar',
    data: {
        labels: {{ faturamento_servico.keys()|list|tojson }},
        datasets: [{
            label: 'Faturamento',
            data: {{ faturamento_servico.values()|list|tojson }},
            backgroundColor: function(context) {
                const value = context.raw;
                return value > 500 ? '#2e7d32' : '#66bb6a';
            },
            borderSkipped: false,
            maxBarThickness: 30
        }]
    },
    options: {
        responsive: true,
        indexAxis: 'y',
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return 'R$ ' + context.raw.toLocaleString('pt-BR');
                    }
                }
            },
            legend: { display: false }
        },
        scales: {
            x: {
                beginAtZero: false,
                grid: { color: '#eee' },
                ticks: {
                    callback: function(value) {
                        return 'R$ ' + value.toLocaleString('pt-BR');
                    },
                    align: 'start'
                }
            },
            y: { grid: { display: false } }
        },
        animation: { duration: 1000, easing: 'easeOutQuart' }
    }
});


// Produtos
new Chart(document.getElementById('graficoProduto'), {
    type: 'bar',
    data: {
        labels: {{ faturamento_produto.keys()|list|tojson }},
        datasets: [{
            label: 'Faturamento',
            data: {{ faturamento_produto.values()|list|tojson }},
            backgroundColor: '#ffa726'
        }]
    },
    options: {
        responsive: true,
        indexAxis: 'y',
        scales: { x: { ticks: { callback: value => 'R$ ' + value.toLocaleString('pt-BR') } } }
    }
});

// Serviços x Produtos
new Chart(document.getElementById('graficoComparativo'), {
    type: 'pie',
    data: {
        labels: ['Serviços', 'Produtos'],
        datasets: [{
            data: {{ comparativo_servico_produto|tojson }},
            backgroundColor: ['#ab47bc', '#29b6f6']
        }]
    },
    options: {
        responsive: true,
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.label + ': R$ ' + context.parsed.toLocaleString('pt-BR');
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}

